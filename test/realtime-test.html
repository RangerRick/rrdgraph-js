<!doctype html>
<title>Realtime Only Test</title>
<style>
  html, body, div {
    padding: 0;
    margin: 0;
  }
</style>

<div class="rrdgraph" data-src="realtime=1"></div>
<div>
  Measurement rate (ms) <input type="text" value="5" id="rate" />
</div>
<div>
  <button id="animate">Start</button>
</div>

<script src="http://d3js.org/d3.v2.min.js"></script>
<script src="../rrdgraph.js"></script>
<script>
  var rrd_command = (
    "/usr/bin/rrdtool graph example.png \\\n" +
    "--slope-mode \\\n" +
    "--title=\"Realtime test\" \\\n" +
    "--rigid \\\n" +
    "--height=200 \\\n" +
    "--width=500 \\\n" +
    "--vertical-label=\"C\" \\\n" +
    "--watermark=\"This is the watermark\" \\\n" +
    "DEF:b=\"example.rrd\":temp:AVERAGE \\\n" +
    "DEF:b_max=\"example.rrd\":temp:MAX \\\n" +
    "DEF:b_min=\"example.rrd\":temp:MIN \\\n" +
    "DEF:c=\"example.rrd\":temp2:AVERAGE \\\n" +
    "DEF:d=\"example2.rrd\":temp:AVERAGE \\\n" +
    "CDEF:b1=b,1,+ \\\n" +
    "VDEF:b_avg=b,AVERAGE \\\n" +
    "LINE1:b#009900:\"b \"  \\\n" +
    "GPRINT:b:LAST:\" Cur\\:%8.2lf \"  \\\n" +
    "GPRINT:b:AVERAGE:\"Avg\\:%8.2lf \"  \\\n" +
    "GPRINT:b:MIN:\"Min\\:%8.2lf \"  \\\n" +
    "GPRINT:b:MAX:\"Max\\:%8.2lf \\n\" \\\n" +
    "LINE1:b_max#ff9900:\"b_max \"  \\\n" +
    "LINE1:b_min#0099ff:\"b_min \"  \\\n" +
    "LINE1:b1#990000:\"b + 1\"  \\\n" +
    "LINE1:c#990000:\"c \"  \\\n" +
    "AREA:d#000099:\"d \"  \\\n" +
    "HRULE:b_avg#bb4499:\"Average b\":dashes=10,2,5,5 \\\n"
    );

    var mappings = {
      '.1.2.3.4.5': 'example.rrd:temp',
      '.1.2.3.4.6': 'example.rrd:temp2',
      '.1.2.3.4.7': 'example2.rrd:temp',
    };






  window.onload = function () {
    var graphs = RRDGraph.init('.rrdgraph', rrd_command);
    var graph = window.graph = graphs[0];

    var dc = new RRDGraph.DataCollector(graph.config, graph.data, mappings);

    var last = {
      b: 20,
      c: 25,
      d: 15
    };

    var def_to_metric = {
      b: '.1.2.3.4.5',
      c: '.1.2.3.4.6',
      d: '.1.2.3.4.7'
    };

    var startStop = function () {
      var rate = parseInt(document.getElementById('rate').value);
      if (window.interval === undefined) {
        dc.setRate(rate);
        document.getElementById('animate').innerHTML = 'Stop';
        window.interval = setInterval(function () {
          var metrics = [];

          for (var p in last) {
            var newDate = +new Date();
            var newValue = last[p] - 0.1 + Math.random() * 0.2;
            last[p] = newValue;

            var newMetric = {
              metricId: def_to_metric[p],
              netInterface: 'random',
              nodeId: 'random',
              service: 'SNMP',
              timeStamp: newDate,
              value: newValue
            };

            metrics.push(newMetric);
          }

          // This is the part that needs to be called when metrics are available.
          dc.push(metrics);

        }, rate);
      } else {
        this.innerHTML = 'Start';
        clearInterval(window.interval);
        window.interval = undefined;
      }
    };

    d3.select('#animate').on('click', startStop);

    d3.select('#rate').on('input', function () {
      clearInterval(window.interval);
      window.interval = undefined;
      startStop();
    });
  };
</script>

